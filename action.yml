name: 'Multi-Language Sanity Check'
description: 'Automated sanity checks and vulnerability scanning for multi-language projects'
author: 'Surabhis12'

branding:
  icon: 'shield'
  color: 'blue'

inputs:
  github-token:
    description: 'GitHub token for posting comments and managing labels'
    required: true
  
  enable-cpp-check:
    description: 'Enable C/C++ checks'
    required: false
    default: 'true'
  
  enable-js-check:
    description: 'Enable JavaScript/TypeScript checks'
    required: false
    default: 'true'
  
  enable-rust-check:
    description: 'Enable Rust checks'
    required: false
    default: 'true'
  
  enable-kotlin-check:
    description: 'Enable Kotlin checks'
    required: false
    default: 'true'
  
  enable-swift-check:
    description: 'Enable Swift checks'
    required: false
    default: 'true'
  
  enable-java-check:
    description: 'Enable Java checks'
    required: false
    default: 'true'
  
  enable-flutter-check:
    description: 'Enable Flutter/Dart checks'
    required: false
    default: 'true'
  
  enable-dependency-scan:
    description: 'Enable dependency vulnerability scanning'
    required: false
    default: 'true'
  
  post-pr-comments:
    description: 'Post results as PR comments'
    required: false
    default: 'true'
  
  apply-labels:
    description: 'Apply pass/fail labels to PRs'
    required: false
    default: 'true'
  
  fail-on-error:
    description: 'Fail workflow if checks fail'
    required: false
    default: 'true'
  
  severity-threshold:
    description: 'Fail on: error, warning, or all'
    required: false
    default: 'error'
  
  ignore-patterns:
    description: 'Comma-separated patterns to ignore'
    required: false
    default: ''
  
  node-version:
    description: 'Node.js version'
    required: false
    default: '20'
  
  java-version:
    description: 'Java version'
    required: false
    default: '17'
  
  java-distribution:
    description: 'Java distribution'
    required: false
    default: 'temurin'
  
  rust-toolchain:
    description: 'Rust toolchain'
    required: false
    default: 'stable'
  
  ktlint-version:
    description: 'ktlint version'
    required: false
    default: '1.0.1'
  
  check-timeout-minutes:
    description: 'Timeout per check in minutes'
    required: false
    default: '10'

outputs:
  status:
    description: 'Overall status of sanity checks (success/failure)'
    value: ${{ steps.run-checks.outputs.status }}

runs:
  using: 'composite'
  steps:
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@c3a1bb2c992d77180ae65be6ae6c166cf40f857c
      with:
        files: |
          **/*.c
          **/*.cpp
          **/*.h
          **/*.hpp
          **/*.js
          **/*.jsx
          **/*.ts
          **/*.tsx
          **/*.rs
          **/*.kt
          **/*.swift
          **/*.java
          **/*.dart
    
    - name: Setup cache directory
      shell: bash
      run: |
        mkdir -p "$HOME/.sanity-check-cache"
        echo "CACHE_DIR=$HOME/.sanity-check-cache" >> $GITHUB_ENV
    
    - name: Detect languages with path sanitization
      if: steps.changed-files.outputs.any_changed == 'true'
      id: detect
      shell: bash
      run: |
        set -euo pipefail
        IFS=$'\n'
        
        echo "=== Language Detection with Path Sanitization ==="
        ACTION_PATH="${{ github.action_path }}"
        
        declare -a SAFE_FILES=()
        while IFS= read -r file; do
          [ -z "$file" ] && continue
          
          clean=$(echo "$file" | sed 's/[;&|`$(){}[\]<>]//g')
          
          if [[ "$file" =~ \.\. ]] || [[ "$file" =~ [[:cntrl:]] ]]; then
            echo "::warning::Rejected suspicious path: $file"
            continue
          fi
          
          SAFE_FILES+=("$file")
        done <<< "${{ steps.changed-files.outputs.all_changed_files }}"
        
        HAS_CPP=false
        HAS_JS=false
        HAS_RUST=false
        HAS_KOTLIN=false
        HAS_SWIFT=false
        HAS_JAVA=false
        HAS_FLUTTER=false
        
        # Clear all file lists
        rm -f cpp_files.txt js_files.txt rust_files.txt kotlin_files.txt swift_files.txt java_files.txt flutter_files.txt
        
        IGNORE_PATTERNS="${{ inputs.ignore-patterns }}"
        
        for file in "${SAFE_FILES[@]}"; do
          # Skip if file doesn't exist
          [ ! -f "$file" ] && continue
          
          # Apply ignore patterns
          if [ -n "$IGNORE_PATTERNS" ]; then
            IFS=',' read -ra PATTERNS <<< "$IGNORE_PATTERNS"
            SKIP=false
            for pattern in "${PATTERNS[@]}"; do
              pattern=$(echo "$pattern" | xargs)
              if [[ "$file" == $pattern ]]; then
                SKIP=true
                echo "Ignoring: $file"
                break
              fi
            done
            [ "$SKIP" = true ] && continue
          fi
          
          # CRITICAL FIX: Use exact extension matching with case statement
          case "$file" in
            *.c|*.cpp|*.cc|*.cxx|*.h|*.hpp|*.hxx)
              if [[ "${{ inputs.enable-cpp-check }}" == "true" ]]; then
                HAS_CPP=true
                echo "$file" >> cpp_files.txt
                echo "  CPP: $file"
              fi
              ;;
            *.js|*.jsx|*.ts|*.tsx|*.mjs|*.cjs)
              if [[ "${{ inputs.enable-js-check }}" == "true" ]]; then
                HAS_JS=true
                echo "$file" >> js_files.txt
                echo "  JS: $file"
              fi
              ;;
            *.rs)
              if [[ "${{ inputs.enable-rust-check }}" == "true" ]]; then
                HAS_RUST=true
                echo "$file" >> rust_files.txt
                echo "  RUST: $file"
              fi
              ;;
            *.kt|*.kts)
              if [[ "${{ inputs.enable-kotlin-check }}" == "true" ]]; then
                HAS_KOTLIN=true
                echo "$file" >> kotlin_files.txt
                echo "  KOTLIN: $file"
              fi
              ;;
            *.swift)
              if [[ "${{ inputs.enable-swift-check }}" == "true" ]]; then
                HAS_SWIFT=true
                echo "$file" >> swift_files.txt
                echo "  SWIFT: $file"
              fi
              ;;
            *.java)
              if [[ "${{ inputs.enable-java-check }}" == "true" ]]; then
                HAS_JAVA=true
                echo "$file" >> java_files.txt
                echo "  JAVA: $file"
              fi
              ;;
            *.dart)
              if [[ "${{ inputs.enable-flutter-check }}" == "true" ]]; then
                HAS_FLUTTER=true
                echo "$file" >> flutter_files.txt
                echo "  DART: $file"
              fi
              ;;
            *)
              # File doesn't match any known language
              ;;
          esac
        done
        
        echo ""
        echo "=== Detection Summary ==="
        [ "$HAS_CPP" = true ] && echo "‚úì C/C++: $(wc -l < cpp_files.txt 2>/dev/null || echo 0) files"
        [ "$HAS_JS" = true ] && echo "‚úì JavaScript: $(wc -l < js_files.txt 2>/dev/null || echo 0) files"
        [ "$HAS_RUST" = true ] && echo "‚úì Rust: $(wc -l < rust_files.txt 2>/dev/null || echo 0) files"
        [ "$HAS_KOTLIN" = true ] && echo "‚úì Kotlin: $(wc -l < kotlin_files.txt 2>/dev/null || echo 0) files"
        [ "$HAS_SWIFT" = true ] && echo "‚úì Swift: $(wc -l < swift_files.txt 2>/dev/null || echo 0) files"
        [ "$HAS_JAVA" = true ] && echo "‚úì Java: $(wc -l < java_files.txt 2>/dev/null || echo 0) files"
        [ "$HAS_FLUTTER" = true ] && echo "‚úì Dart: $(wc -l < flutter_files.txt 2>/dev/null || echo 0) files"
        
        echo "has_cpp=$HAS_CPP" >> $GITHUB_OUTPUT
        echo "has_js=$HAS_JS" >> $GITHUB_OUTPUT
        echo "has_rust=$HAS_RUST" >> $GITHUB_OUTPUT
        echo "has_kotlin=$HAS_KOTLIN" >> $GITHUB_OUTPUT
        echo "has_swift=$HAS_SWIFT" >> $GITHUB_OUTPUT
        echo "has_java=$HAS_JAVA" >> $GITHUB_OUTPUT
        echo "has_flutter=$HAS_FLUTTER" >> $GITHUB_OUTPUT
        echo "ACTION_PATH=$ACTION_PATH" >> $GITHUB_ENV
    
    - name: Cache C/C++ tools
      if: steps.detect.outputs.has_cpp == 'true' && inputs.enable-cpp-check == 'true'
      uses: actions/cache@v4
      with:
        path: ${{ env.CACHE_DIR }}/cppcheck
        key: cppcheck-${{ runner.os }}-v1
    
    - name: Install C/C++ tools
      if: steps.detect.outputs.has_cpp == 'true' && inputs.enable-cpp-check == 'true'
      shell: bash
      run: |
        if ! command -v cppcheck &> /dev/null; then
          sudo apt-get update -qq
          sudo apt-get install -y cppcheck
        fi
    
    - name: Cache Node.js
      if: steps.detect.outputs.has_js == 'true' && inputs.enable-js-check == 'true'
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: node-${{ runner.os }}-${{ inputs.node-version }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: node-${{ runner.os }}-${{ inputs.node-version }}-
    
    - name: Setup Node.js
      if: steps.detect.outputs.has_js == 'true' && inputs.enable-js-check == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}
    
    - name: Cache Rust
      if: steps.detect.outputs.has_rust == 'true' && inputs.enable-rust-check == 'true'
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
        key: rust-${{ runner.os }}-${{ inputs.rust-toolchain }}-v1
    
    - name: Setup Rust
      if: steps.detect.outputs.has_rust == 'true' && inputs.enable-rust-check == 'true'
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ inputs.rust-toolchain }}
        components: clippy
    
    - name: Setup Java
      if: steps.detect.outputs.has_java == 'true' && inputs.enable-java-check == 'true'
      uses: actions/setup-java@v4
      with:
        distribution: ${{ inputs.java-distribution }}
        java-version: ${{ inputs.java-version }}
    
    - name: Cache Kotlin linter
      if: steps.detect.outputs.has_kotlin == 'true' && inputs.enable-kotlin-check == 'true'
      uses: actions/cache@v4
      with:
        path: ${{ env.CACHE_DIR }}/ktlint
        key: ktlint-${{ runner.os }}-${{ inputs.ktlint-version }}
    
    - name: Install Kotlin linter
      if: steps.detect.outputs.has_kotlin == 'true' && inputs.enable-kotlin-check == 'true'
      shell: bash
      run: |
        KTLINT_PATH="${{ env.CACHE_DIR }}/ktlint/ktlint"
        if [ ! -f "$KTLINT_PATH" ]; then
          mkdir -p "${{ env.CACHE_DIR }}/ktlint"
          curl -sSLO "https://github.com/pinterest/ktlint/releases/download/${{ inputs.ktlint-version }}/ktlint"
          chmod +x ktlint
          mv ktlint "$KTLINT_PATH"
        fi
        sudo ln -sf "$KTLINT_PATH" /usr/local/bin/ktlint || true
    
    - name: Run dependency scans
      if: inputs.enable-dependency-scan == 'true'
      id: dependency-scan
      continue-on-error: true
      shell: bash
      run: |
        echo "=== Dependency Vulnerability Scanning ==="
        SCAN_FAILED=false
        TIMEOUT_SEC=$((60 * ${{ inputs.check-timeout-minutes }}))
        
        if [ -f "package-lock.json" ] && [ "${{ steps.detect.outputs.has_js }}" = "true" ]; then
          echo "Running npm audit..."
          if ! timeout ${TIMEOUT_SEC} npm audit --audit-level=moderate 2>&1 | tee npm_audit.txt; then
            echo "::warning::npm audit found vulnerabilities"
            SCAN_FAILED=true
          fi
        fi
        
        if [ -f "Cargo.lock" ] && [ "${{ steps.detect.outputs.has_rust }}" = "true" ]; then
          echo "Running cargo audit..."
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit --quiet || true
          fi
          if command -v cargo-audit &> /dev/null; then
            if ! timeout ${TIMEOUT_SEC} cargo audit 2>&1 | tee cargo_audit.txt; then
              echo "::warning::cargo audit found vulnerabilities"
              SCAN_FAILED=true
            fi
          fi
        fi
        
        if [ "$SCAN_FAILED" = true ]; then
          echo "vulnerability_found=true" >> $GITHUB_OUTPUT
        else
          echo "vulnerability_found=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Run sanity checks in parallel
      if: steps.changed-files.outputs.any_changed == 'true'
      id: run-checks
      continue-on-error: true
      shell: bash
      run: |
        echo "================================"
        echo "   RUNNING SANITY CHECKS (PARALLEL)"
        echo "================================"
        echo ""
        
        OVERALL_STATUS=0
        ACTION_PATH="${{ github.action_path }}"
        TIMEOUT_SEC=$((60 * ${{ inputs.check-timeout-minutes }}))
        
        run_check_parallel() {
          local lang=$1
          local script=$2
          local enabled=$3
          
          if [ "$enabled" = "true" ]; then
            echo ">>> Starting $lang checks..."
            (
              if timeout ${TIMEOUT_SEC} bash "$ACTION_PATH/scripts/$script" 2>&1 | tee "${lang}_check.txt"; then
                echo "‚úÖ $lang checks passed"
                exit 0
              else
                exit_code=$?
                if [ $exit_code -eq 124 ]; then
                  echo "‚è±Ô∏è  $lang checks timed out after ${{ inputs.check-timeout-minutes }} minutes"
                else
                  echo "‚ùå $lang checks failed"
                fi
                exit 1
              fi
            ) &
          fi
        }
        
        declare -a pids=()
        
        if [ "${{ steps.detect.outputs.has_cpp }}" = "true" ] && [ "${{ inputs.enable-cpp-check }}" = "true" ]; then
          run_check_parallel "cpp" "cpp-check.sh" "true"
          pids+=($!)
        fi
        
        if [ "${{ steps.detect.outputs.has_js }}" = "true" ] && [ "${{ inputs.enable-js-check }}" = "true" ]; then
          run_check_parallel "js" "js-check.sh" "true"
          pids+=($!)
        fi
        
        if [ "${{ steps.detect.outputs.has_rust }}" = "true" ] && [ "${{ inputs.enable-rust-check }}" = "true" ]; then
          run_check_parallel "rust" "rust-check.sh" "true"
          pids+=($!)
        fi
        
        if [ "${{ steps.detect.outputs.has_kotlin }}" = "true" ] && [ "${{ inputs.enable-kotlin-check }}" = "true" ]; then
          run_check_parallel "kotlin" "kotlin-check.sh" "true"
          pids+=($!)
        fi
        
        if [ "${{ steps.detect.outputs.has_swift }}" = "true" ] && [ "${{ inputs.enable-swift-check }}" = "true" ]; then
          run_check_parallel "swift" "swift-check.sh" "true"
          pids+=($!)
        fi
        
        if [ "${{ steps.detect.outputs.has_java }}" = "true" ] && [ "${{ inputs.enable-java-check }}" = "true" ]; then
          run_check_parallel "java" "java-check.sh" "true"
          pids+=($!)
        fi
        
        if [ "${{ steps.detect.outputs.has_flutter }}" = "true" ] && [ "${{ inputs.enable-flutter-check }}" = "true" ]; then
          run_check_parallel "flutter" "flutter-check.sh" "true"
          pids+=($!)
        fi
        
        echo ""
        echo "Waiting for all checks to complete..."
        for pid in "${pids[@]}"; do
          if ! wait "$pid"; then
            OVERALL_STATUS=1
          fi
        done
        
        cat *_check.txt 2>/dev/null > check_results.txt || echo "No check results" > check_results.txt
        
        echo ""
        echo "================================"
        if [ $OVERALL_STATUS -eq 0 ] && [ "${{ steps.dependency-scan.outputs.vulnerability_found }}" != "true" ]; then
          echo "‚úÖ ALL SANITY CHECKS PASSED"
          echo "status=success" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "‚ùå SANITY CHECKS FAILED"
          echo "status=failure" >> $GITHUB_OUTPUT
          
          if [ "${{ inputs.fail-on-error }}" = "true" ]; then
            exit 1
          else
            echo "::warning::Checks failed but fail-on-error is disabled"
            exit 0
          fi
        fi
    
    - name: Post results as PR comment
      if: github.event_name == 'pull_request' && inputs.post-pr-comments == 'true' && always()
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const fs = require('fs');
          const status = '${{ steps.run-checks.outputs.status }}';
          const statusEmoji = status === 'success' ? '‚úÖ' : '‚ùå';
          const statusText = status === 'success' ? 'PASSED' : 'FAILED';
          
          let results = '';
          try {
            results = fs.readFileSync('check_results.txt', 'utf8');
          } catch (error) {
            results = 'Could not read check results';
          }
          
          let errorSummary = '';
          
          if (status === 'failure') {
            const lines = results.split('\n');
            errorSummary = '\n## üö® Key Issues Found:\n\n';
            
            let currentLanguage = '';
            let languageErrors = {};
            
            for (let i = 0; i < lines.length; i++) {
              const line = lines[i];
              
              if (line.includes('C/C++ SANITY CHECK')) {
                currentLanguage = 'C/C++';
                languageErrors[currentLanguage] = [];
              } else if (line.includes('RUST SANITY CHECK')) {
                currentLanguage = 'Rust';
                languageErrors[currentLanguage] = [];
              } else if (line.includes('JAVASCRIPT SANITY CHECK')) {
                currentLanguage = 'JavaScript';
                languageErrors[currentLanguage] = [];
              } else if (line.includes('KOTLIN SANITY CHECK')) {
                currentLanguage = 'Kotlin';
                languageErrors[currentLanguage] = [];
              } else if (line.includes('JAVA SANITY CHECK')) {
                currentLanguage = 'Java';
                languageErrors[currentLanguage] = [];
              } else if (line.includes('SWIFT SANITY CHECK')) {
                currentLanguage = 'Swift';
                languageErrors[currentLanguage] = [];
              } else if (line.includes('FLUTTER/DART SANITY CHECK')) {
                currentLanguage = 'Dart/Flutter';
                languageErrors[currentLanguage] = [];
              }
              
              if (currentLanguage && line.match(/.*:\d+:.*(?:error|warning):/)) {
                languageErrors[currentLanguage].push(line.trim());
              }
            }
            
            let totalErrors = 0;
            for (const [lang, errors] of Object.entries(languageErrors)) {
              if (errors.length > 0) {
                totalErrors += errors.length;
                errorSummary += `### ${lang}\n`;
                errors.slice(0, 10).forEach(error => {
                  errorSummary += `- ${error}\n`;
                });
                if (errors.length > 10) {
                  errorSummary += `... and ${errors.length - 10} more\n`;
                }
                errorSummary += '\n';
              }
            }
            
            if (totalErrors > 0) {
              errorSummary += `**Total issues found: ${totalErrors}**\n\n`;
            }
            
            if ('${{ steps.dependency-scan.outputs.vulnerability_found }}' === 'true') {
              errorSummary += '### üîí Dependency Vulnerabilities\n';
              errorSummary += 'Vulnerabilities found in dependencies. Check workflow logs for details.\n\n';
            }
            
            errorSummary += '---\n';
          }
          
          const languagesList = [];
          if ('${{ steps.detect.outputs.has_cpp }}' === 'true') languagesList.push('C/C++');
          if ('${{ steps.detect.outputs.has_js }}' === 'true') languagesList.push('JavaScript/TypeScript');
          if ('${{ steps.detect.outputs.has_rust }}' === 'true') languagesList.push('Rust');
          if ('${{ steps.detect.outputs.has_kotlin }}' === 'true') languagesList.push('Kotlin');
          if ('${{ steps.detect.outputs.has_swift }}' === 'true') languagesList.push('Swift');
          if ('${{ steps.detect.outputs.has_java }}' === 'true') languagesList.push('Java');
          if ('${{ steps.detect.outputs.has_flutter }}' === 'true') languagesList.push('Dart/Flutter');
          
          const body = `## ${statusEmoji} Sanity Check ${statusText}
          
          ${status === 'failure' ? '‚ö†Ô∏è **Action Required:** Please fix the issues below before merging.\n' : '‚úÖ **All checks passed!** Your code meets quality standards.\n'}
          
          **Languages Checked:** ${languagesList.join(', ') || 'None'}
          
          ${errorSummary}
          
          <details>
          <summary>üìã Click to view full detailed results</summary>
          
          \`\`\`
          ${results}
          \`\`\`
          
          </details>
          
          ---
          ${status === 'failure' ? '**Next Steps:** Fix the reported issues, commit your changes, and the checks will re-run automatically.\n\n' : ''}*Automated sanity checks completed at ${new Date().toISOString()}*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Add label
      if: github.event_name == 'pull_request' && inputs.apply-labels == 'true' && always()
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const status = '${{ steps.run-checks.outputs.status }}';
          const label = status === 'success' ? 'sanity-check-passed' : 'sanity-check-failed';
          const oppositeLabel = status === 'success' ? 'sanity-check-failed' : 'sanity-check-passed';
          
          try {
            await github.rest.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: oppositeLabel
            });
          } catch (error) {}
          
          try {
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [label]
            });
          } catch (error) {
            try {
              const color = status === 'success' ? '0e8a16' : 'd73a4a';
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: label,
                color: color,
                description: `Sanity check ${status === 'success' ? 'passed' : 'failed'}`
              });
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: [label]
              });
            } catch (createError) {
              console.error(`Failed to create/add label: ${createError.message}`);
            }
          }
    
    - name: Fail workflow if checks failed
      if: steps.run-checks.outputs.status == 'failure' && inputs.fail-on-error == 'true'
      shell: bash
      run: |
        echo "::error::Sanity checks failed. Please fix the issues before merging."
        exit 1